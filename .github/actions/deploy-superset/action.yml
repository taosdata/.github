name: Deploy Superset with Docker
description: Deploy Apache Superset using Docker with configurable Redis and database dependencies

inputs:
  # Superset é…ç½®
  superset-version:
    description: 'Superset Docker image version'
    required: false
    default: 'latest'
  
  superset-port:
    description: 'Port to expose Superset service'
    required: false
    default: '8088'
  
  superset-secret-key:
    description: 'Secret key for Superset'
    required: true
  
  # æ•°æ®åº“é…ç½®
  database-type:
    description: 'Database type (postgresql, mysql)'
    required: true
  
  database-host:
    description: 'Database host'
    required: true
  
  database-port:
    description: 'Database port'
    required: false
    default: '5432'
  
  database-name:
    description: 'Database name'
    required: true
  
  database-user:
    description: 'Database username'
    required: true
  
  database-password:
    description: 'Database password'
    required: true
  
  # Redis é…ç½®
  redis-host:
    description: 'Redis host'
    required: true
  
  redis-port:
    description: 'Redis port'
    required: false
    default: '6379'
  
  redis-password:
    description: 'Redis password (optional)'
    required: false
    default: ''
  
  redis-db:
    description: 'Redis database number'
    required: false
    default: '1'
  
  # éƒ¨ç½²é…ç½®
  container-name:
    description: 'Container name for Superset'
    required: false
    default: 'superset'
  
  network-name:
    description: 'Docker network name'
    required: false
    default: 'superset-network'
  
  admin-username:
    description: 'Superset admin username'
    required: false
    default: 'admin'
  
  admin-email:
    description: 'Superset admin email'
    required: false
    default: 'admin@superset.com'
  
  admin-password:
    description: 'Superset admin password'
    required: true
  
  # é«˜çº§é…ç½®
  enable-oauth:
    description: 'Enable OAuth authentication'
    required: false
    default: 'false'
  
  custom-config:
    description: 'Custom Superset configuration (base64 encoded)'
    required: false
    default: ''

outputs:
  superset-url:
    description: 'URL to access Superset'
    value: ${{ steps.deploy.outputs.superset-url }}
  
  container-id:
    description: 'Container ID of deployed Superset'
    value: ${{ steps.deploy.outputs.container-id }}

runs:
  using: 'composite'
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        echo "ğŸ” éªŒè¯è¾“å…¥å‚æ•°..."
        
        # éªŒè¯æ•°æ®åº“ç±»å‹
        if [[ "${{ inputs.database-type }}" != "postgresql" && "${{ inputs.database-type }}" != "mysql" ]]; then
          echo "âŒ é”™è¯¯: database-type å¿…é¡»æ˜¯ 'postgresql' æˆ– 'mysql'"
          exit 1
        fi
        
        # éªŒè¯å¿…éœ€å‚æ•°
        if [[ -z "${{ inputs.superset-secret-key }}" ]]; then
          echo "âŒ é”™è¯¯: superset-secret-key æ˜¯å¿…éœ€çš„"
          exit 1
        fi
        
        if [[ -z "${{ inputs.admin-password }}" ]]; then
          echo "âŒ é”™è¯¯: admin-password æ˜¯å¿…éœ€çš„"
          exit 1
        fi
        
        echo "âœ… è¾“å…¥å‚æ•°éªŒè¯é€šè¿‡"

    - name: Setup Docker network
      shell: bash
      run: |
        echo "ğŸŒ åˆ›å»º Docker ç½‘ç»œ..."
        
        # æ£€æŸ¥ç½‘ç»œæ˜¯å¦å·²å­˜åœ¨
        if ! docker network ls | grep -q "${{ inputs.network-name }}"; then
          docker network create ${{ inputs.network-name }}
          echo "âœ… åˆ›å»ºç½‘ç»œ: ${{ inputs.network-name }}"
        else
          echo "â„¹ï¸ ç½‘ç»œå·²å­˜åœ¨: ${{ inputs.network-name }}"
        fi

    - name: Generate Superset configuration
      shell: bash
      run: |
        echo "ğŸ“ ç”Ÿæˆ Superset é…ç½®..."
        
        # åˆ›å»ºé…ç½®ç›®å½•
        mkdir -p ./superset-config
        
        # ç”Ÿæˆæ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
        if [[ "${{ inputs.database-type }}" == "postgresql" ]]; then
          DB_URI="postgresql+psycopg2://${{ inputs.database-user }}:${{ inputs.database-password }}@${{ inputs.database-host }}:${{ inputs.database-port }}/${{ inputs.database-name }}"
        elif [[ "${{ inputs.database-type }}" == "mysql" ]]; then
          DB_URI="mysql+pymysql://${{ inputs.database-user }}:${{ inputs.database-password }}@${{ inputs.database-host }}:${{ inputs.database-port }}/${{ inputs.database-name }}"
        fi
        
        # ç”Ÿæˆ Redis è¿æ¥å­—ç¬¦ä¸²
        if [[ -n "${{ inputs.redis-password }}" ]]; then
          REDIS_URI="redis://:${{ inputs.redis-password }}@${{ inputs.redis-host }}:${{ inputs.redis-port }}/${{ inputs.redis-db }}"
        else
          REDIS_URI="redis://${{ inputs.redis-host }}:${{ inputs.redis-port }}/${{ inputs.redis-db }}"
        fi
        
        # ç”Ÿæˆ superset_config.py
        cat > ./superset-config/superset_config.py << 'EOF'
        import os
        from datetime import timedelta
        
        # æ•°æ®åº“é…ç½®
        SQLALCHEMY_DATABASE_URI = os.environ.get('DATABASE_URI')
        
        # Redis é…ç½®
        REDIS_HOST = os.environ.get('REDIS_HOST')
        REDIS_PORT = int(os.environ.get('REDIS_PORT', 6379))
        REDIS_DB = int(os.environ.get('REDIS_DB', 1))
        
        # Celery é…ç½®
        CELERY_CONFIG = {
            'broker_url': os.environ.get('REDIS_URI'),
            'imports': ('superset.sql_lab',),
            'result_backend': os.environ.get('REDIS_URI'),
            'worker_prefetch_multiplier': 1,
            'task_acks_late': False,
            'task_annotations': {
                'sql_lab.get_sql_results': {
                    'rate_limit': '100/s',
                },
            },
        }
        
        # å®‰å…¨é…ç½®
        SECRET_KEY = os.environ.get('SECRET_KEY')
        
        # ä¼šè¯é…ç½®
        PERMANENT_SESSION_LIFETIME = timedelta(days=31)
        
        # åŠŸèƒ½æ ‡å¿—
        FEATURE_FLAGS = {
            'DASHBOARD_RBAC': True,
            'ENABLE_TEMPLATE_PROCESSING': True,
        }
        
        # Web æœåŠ¡å™¨é…ç½®
        SUPERSET_WEBSERVER_PORT = 8088
        SUPERSET_WEBSERVER_TIMEOUT = 60
        
        # æ—¥å¿—é…ç½®
        ENABLE_TIME_ROTATE = True
        TIME_ROTATE_LOG_LEVEL = 'INFO'
        FILENAME = '/app/superset_home/superset.log'
        ROLLOVER = 'midnight'
        INTERVAL = 1
        BACKUP_COUNT = 30
        
        # ç¼“å­˜é…ç½®
        CACHE_CONFIG = {
            'CACHE_TYPE': 'redis',
            'CACHE_DEFAULT_TIMEOUT': 300,
            'CACHE_KEY_PREFIX': 'superset_',
            'CACHE_REDIS_HOST': os.environ.get('REDIS_HOST'),
            'CACHE_REDIS_PORT': int(os.environ.get('REDIS_PORT', 6379)),
            'CACHE_REDIS_DB': int(os.environ.get('REDIS_DB', 1)),
        }
        
        # æ•°æ®ç¼“å­˜é…ç½®
        DATA_CACHE_CONFIG = CACHE_CONFIG
        
        # å¦‚æœæœ‰è‡ªå®šä¹‰é…ç½®ï¼ŒåŠ è½½å®ƒ
        if os.path.exists('/app/pythonpath/custom_config.py'):
            exec(open('/app/pythonpath/custom_config.py').read())
        EOF
        
        # å¦‚æœæä¾›äº†è‡ªå®šä¹‰é…ç½®ï¼Œè§£ç å¹¶ä¿å­˜
        if [[ -n "${{ inputs.custom-config }}" ]]; then
          echo "${{ inputs.custom-config }}" | base64 -d > ./superset-config/custom_config.py
          echo "âœ… è‡ªå®šä¹‰é…ç½®å·²ä¿å­˜"
        fi
        
        # ä¿å­˜ç¯å¢ƒå˜é‡åˆ°æ–‡ä»¶
        cat > ./superset-config/.env << EOF
        DATABASE_URI=${DB_URI}
        REDIS_URI=${REDIS_URI}
        REDIS_HOST=${{ inputs.redis-host }}
        REDIS_PORT=${{ inputs.redis-port }}
        REDIS_DB=${{ inputs.redis-db }}
        SECRET_KEY=${{ inputs.superset-secret-key }}
        SUPERSET_ENV=production
        EOF
        
        echo "âœ… Superset é…ç½®ç”Ÿæˆå®Œæˆ"

    - name: Create initialization script
      shell: bash
      run: |
        echo "ğŸ“œ åˆ›å»ºåˆå§‹åŒ–è„šæœ¬..."
        
        cat > ./superset-config/init-superset.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ åˆå§‹åŒ– Superset..."
        
        # ç­‰å¾…æ•°æ®åº“è¿æ¥
        echo "â³ ç­‰å¾…æ•°æ®åº“è¿æ¥..."
        python -c "
        import time
        import sqlalchemy as sa
        import os
        
        max_retries = 30
        retry_interval = 2
        
        for i in range(max_retries):
            try:
                engine = sa.create_engine(os.environ['DATABASE_URI'])
                engine.connect()
                print('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ')
                break
            except Exception as e:
                if i == max_retries - 1:
                    print(f'âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}')
                    exit(1)
                print(f'â³ æ•°æ®åº“è¿æ¥é‡è¯• {i+1}/{max_retries}...')
                time.sleep(retry_interval)
        "
        
        # å‡çº§æ•°æ®åº“
        echo "ğŸ“Š å‡çº§æ•°æ®åº“schema..."
        superset db upgrade
        
        # åˆå§‹åŒ–è§’è‰²å’Œæƒé™
        echo "ğŸ” åˆå§‹åŒ–è§’è‰²å’Œæƒé™..."
        superset init
        
        # åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
        echo "ğŸ‘¤ åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·..."
        superset fab create-admin \
            --username "${ADMIN_USERNAME}" \
            --firstname "Superset" \
            --lastname "Admin" \
            --email "${ADMIN_EMAIL}" \
            --password "${ADMIN_PASSWORD}" || true
        
        echo "âœ… Superset åˆå§‹åŒ–å®Œæˆ"
        EOF
        
        chmod +x ./superset-config/init-superset.sh
        echo "âœ… åˆå§‹åŒ–è„šæœ¬åˆ›å»ºå®Œæˆ"

    - name: Deploy Superset
      id: deploy
      shell: bash
      run: |
        echo "ğŸš€ éƒ¨ç½² Superset æœåŠ¡..."
        
        # åœæ­¢å¹¶åˆ é™¤ç°æœ‰å®¹å™¨
        if docker ps -a | grep -q "${{ inputs.container-name }}"; then
          echo "ğŸ›‘ åœæ­¢ç°æœ‰å®¹å™¨..."
          docker stop ${{ inputs.container-name }} || true
          docker rm ${{ inputs.container-name }} || true
        fi
        
        # å¯åŠ¨ Superset å®¹å™¨
        echo "ğŸ³ å¯åŠ¨ Superset å®¹å™¨..."
        CONTAINER_ID=$(docker run -d \
          --name ${{ inputs.container-name }} \
          --network ${{ inputs.network-name }} \
          -p ${{ inputs.superset-port }}:8088 \
          -v "$(pwd)/superset-config:/app/pythonpath" \
          --env-file ./superset-config/.env \
          -e ADMIN_USERNAME="${{ inputs.admin-username }}" \
          -e ADMIN_EMAIL="${{ inputs.admin-email }}" \
          -e ADMIN_PASSWORD="${{ inputs.admin-password }}" \
          apache/superset:${{ inputs.superset-version }} \
          bash -c "/app/pythonpath/init-superset.sh && superset run -h 0.0.0.0 -p 8088 --with-threads --reload --debugger")
        
        echo "container-id=${CONTAINER_ID}" >> $GITHUB_OUTPUT
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾… Superset æœåŠ¡å¯åŠ¨..."
        for i in {1..60}; do
          if docker logs ${{ inputs.container-name }} 2>&1 | grep -q "Running on"; then
            echo "âœ… Superset æœåŠ¡å¯åŠ¨æˆåŠŸ"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "âŒ Superset æœåŠ¡å¯åŠ¨è¶…æ—¶"
            docker logs ${{ inputs.container-name }}
            exit 1
          fi
          sleep 5
        done
        
        # è¾“å‡ºè®¿é—®åœ°å€
        SUPERSET_URL="http://localhost:${{ inputs.superset-port }}"
        echo "superset-url=${SUPERSET_URL}" >> $GITHUB_OUTPUT
        
        echo "ğŸ‰ Superset éƒ¨ç½²å®Œæˆ!"
        echo "ğŸ“± è®¿é—®åœ°å€: ${SUPERSET_URL}"
        echo "ğŸ‘¤ ç®¡ç†å‘˜è´¦å·: ${{ inputs.admin-username }}"

    - name: Health check
      shell: bash
      run: |
        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if ! docker ps | grep -q "${{ inputs.container-name }}"; then
          echo "âŒ å®¹å™¨æœªè¿è¡Œ"
          docker logs ${{ inputs.container-name }}
          exit 1
        fi
        
        # æ£€æŸ¥æœåŠ¡å“åº”
        for i in {1..12}; do
          if curl -f -s "http://localhost:${{ inputs.superset-port }}/health" > /dev/null; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          if [ $i -eq 12 ]; then
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi
          echo "â³ ç­‰å¾…æœåŠ¡å“åº”... ($i/12)"
          sleep 5
        done

    - name: Display deployment info
      shell: bash
      run: |
        echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯æ±‡æ€»:"
        echo "=================="
        echo "ğŸ”— Superset URL: http://localhost:${{ inputs.superset-port }}"
        echo "ğŸ‘¤ ç®¡ç†å‘˜ç”¨æˆ·: ${{ inputs.admin-username }}"
        echo "ğŸ“§ ç®¡ç†å‘˜é‚®ç®±: ${{ inputs.admin-email }}"
        echo "ğŸ³ å®¹å™¨åç§°: ${{ inputs.container-name }}"
        echo "ğŸŒ ç½‘ç»œåç§°: ${{ inputs.network-name }}"
        echo "ğŸ’¾ æ•°æ®åº“ç±»å‹: ${{ inputs.database-type }}"
        echo "ğŸ“¡ Redis ä¸»æœº: ${{ inputs.redis-host }}:${{ inputs.redis-port }}"
        echo "=================="
        echo ""
        echo "ğŸ› ï¸ ç®¡ç†å‘½ä»¤:"
        echo "æŸ¥çœ‹æ—¥å¿—: docker logs -f ${{ inputs.container-name }}"
        echo "è¿›å…¥å®¹å™¨: docker exec -it ${{ inputs.container-name }} bash"
        echo "åœæ­¢æœåŠ¡: docker stop ${{ inputs.container-name }}"
        echo "é‡å¯æœåŠ¡: docker restart ${{ inputs.container-name }}"
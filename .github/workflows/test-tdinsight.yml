name: Install Grafana + TDinsight Dashboard

# æ‰‹åŠ¨è§¦å‘å·¥ä½œæµï¼Œæ”¯æŒåœ¨ GitHub å‰ç«¯ç•Œé¢æ“ä½œ
on:
  workflow_dispatch:
    inputs:
      target_host:
        description: 'ç›®æ ‡ä¸»æœºIPåœ°å€'
        required: true
        default: '192.168.1.100'
        type: string
      
      tdengine_host:
        description: 'TDengine æœåŠ¡å™¨IPåœ°å€'
        required: true
        default: '192.168.1.100'
        type: string
      
      tdengine_port:
        description: 'TDengine æœåŠ¡ç«¯å£'
        required: false
        default: '6041'
        type: string
      
      grafana_admin_password:
        description: 'Grafana ç®¡ç†å‘˜å¯†ç '
        required: false
        default: 'admin123'
        type: string
      
      dashboard_ids:
        description: 'TDinsight ä»ªè¡¨æ¿ IDs (é€—å·åˆ†éš”)'
        required: false
        default: '15146,15155,15167'
        type: string
      
      dashboard_uids:
        description: 'TDinsight ä»ªè¡¨æ¿ UIDs (é€—å·åˆ†éš”)'
        required: false
        default: 'tdinsight,tdinsight-cluster,tdinsight-alert'
        type: string

# ç¯å¢ƒå˜é‡å®šä¹‰
env:
  GRAFANA_PORT: 3000
  GRAFANA_USER: admin
  GRAFANA_PASSWORD: ${{ github.event.inputs.grafana_admin_password }}
  TDENGINE_HOST: ${{ github.event.inputs.tdengine_host }}
  TDENGINE_PORT: ${{ github.event.inputs.tdengine_port }}
  TARGET_HOST: ${{ github.event.inputs.target_host }}
  DASHBOARD_IDS: ${{ github.event.inputs.dashboard_ids }}
  DASHBOARD_UIDS: ${{ github.event.inputs.dashboard_uids }}

jobs:
  install-monitoring:
    name: å®‰è£… Grafana + TDinsight ç›‘æ§æ–¹æ¡ˆ
    
    # æŒ‡å®šè¿è¡Œåœ¨ç‰¹å®šçš„ self-hosted runner
    runs-on: 
      - self-hosted
      - customers  # group æ ‡ç­¾
      - u2-191     # å…·ä½“çš„ runner æ ‡ç­¾
    
    # è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º30åˆ†é’Ÿ
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      - name: æ˜¾ç¤ºè¿è¡Œç¯å¢ƒä¿¡æ¯
        run: |
          echo "ğŸš€ å¼€å§‹åœ¨ runner u2-191 ä¸Šå®‰è£… Grafana + TDinsight"
          echo "ç›®æ ‡ä¸»æœº: ${{ env.TARGET_HOST }}"
          echo "TDengine ä¸»æœº: ${{ env.TDENGINE_HOST }}:${{ env.TDENGINE_PORT }}"
          echo "ä»ªè¡¨æ¿ IDs: ${{ env.DASHBOARD_IDS }}"
          echo "ä»ªè¡¨æ¿ UIDs: ${{ env.DASHBOARD_UIDS }}"
          echo "å½“å‰è¿è¡Œç¯å¢ƒ:"
          hostname
          whoami
          pwd
          df -h
      
      - name: æ£€æŸ¥ç›®æ ‡ä¸»æœºè¿é€šæ€§
        run: |
          echo "ğŸ” æ£€æŸ¥ç›®æ ‡ä¸»æœº ${{ env.TARGET_HOST }} è¿é€šæ€§..."
          ping -c 3 ${{ env.TARGET_HOST }} || {
            echo "âŒ æ— æ³•è¿æ¥åˆ°ç›®æ ‡ä¸»æœº ${{ env.TARGET_HOST }}"
            exit 1
          }
          echo "âœ… ç›®æ ‡ä¸»æœºè¿é€šæ€§æ£€æŸ¥é€šè¿‡"
      
      - name: æ£€æŸ¥ TDengine æœåŠ¡è¿é€šæ€§
        run: |
          echo "ğŸ” æ£€æŸ¥ TDengine æœåŠ¡ ${{ env.TDENGINE_HOST }}:${{ env.TDENGINE_PORT }} è¿é€šæ€§..."
          nc -z ${{ env.TDENGINE_HOST }} ${{ env.TDENGINE_PORT }} || {
            echo "âŒ æ— æ³•è¿æ¥åˆ° TDengine æœåŠ¡ ${{ env.TDENGINE_HOST }}:${{ env.TDENGINE_PORT }}"
            exit 1
          }
          echo "âœ… TDengine æœåŠ¡è¿é€šæ€§æ£€æŸ¥é€šè¿‡"
      
      - name: å®‰è£… Grafana
        uses: taosdata/.github/.github/actions/install-grafana@main
        with:
          target-host: ${{ env.TARGET_HOST }}
          grafana-port: ${{ env.GRAFANA_PORT }}
          admin-password: ${{ env.GRAFANA_PASSWORD }}
      
      - name: ç­‰å¾… Grafana æœåŠ¡å¯åŠ¨
        run: |
          echo "â³ ç­‰å¾… Grafana æœåŠ¡å®Œå…¨å¯åŠ¨..."
          max_attempts=30
          attempt=1
          
          while [ $attempt -le $max_attempts ]; do
            if curl -s -f "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/api/health" > /dev/null 2>&1; then
              echo "âœ… Grafana æœåŠ¡å·²æˆåŠŸå¯åŠ¨ (å°è¯• $attempt/$max_attempts)"
              break
            else
              echo "â³ Grafana æœåŠ¡å°šæœªå°±ç»ªï¼Œç­‰å¾…ä¸­... (å°è¯• $attempt/$max_attempts)"
              sleep 10
              ((attempt++))
            fi
          done
          
          if [ $attempt -gt $max_attempts ]; then
            echo "âŒ Grafana æœåŠ¡å¯åŠ¨è¶…æ—¶"
            exit 1
          fi
      
      - name: å®‰è£… Grafana TDengine æ•°æ®æºæ’ä»¶
        uses: taosdata/.github/.github/actions/install-grafana-plugin@main
        with:
          grafana-host: ${{ env.TARGET_HOST }}
          grafana-port: ${{ env.GRAFANA_PORT }}
          grafana-user: ${{ env.GRAFANA_USER }}
          grafana-password: ${{ env.GRAFANA_PASSWORD }}
          monitor-ip: ${{ env.TDENGINE_HOST }}
          monitor-port: ${{ env.TDENGINE_PORT }}
      
      - name: å¯¼å…¥ TDinsight ä»ªè¡¨æ¿
        uses: taosdata/.github/.github/actions/import-grafana-dashboard@main
        with:
          grafana-url: "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}"
          grafana-user: ${{ env.GRAFANA_USER }}
          grafana-password: ${{ env.GRAFANA_PASSWORD }}
          dashboard-ids: ${{ env.DASHBOARD_IDS }}
          dashboard-uids: ${{ env.DASHBOARD_UIDS }}
      
      - name: éªŒè¯å®‰è£…ç»“æœ
        run: |
          echo "ğŸ” éªŒè¯ Grafana + TDinsight å®‰è£…ç»“æœ..."
          
          # æ£€æŸ¥ Grafana æœåŠ¡çŠ¶æ€
          echo "æ£€æŸ¥ Grafana æœåŠ¡çŠ¶æ€:"
          curl -s -u "${{ env.GRAFANA_USER }}:${{ env.GRAFANA_PASSWORD }}" \
            "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/api/admin/stats" | jq .
          
          # æ£€æŸ¥æ•°æ®æºé…ç½®
          echo "æ£€æŸ¥ TDengine æ•°æ®æº:"
          curl -s -u "${{ env.GRAFANA_USER }}:${{ env.GRAFANA_PASSWORD }}" \
            "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/api/datasources" | jq '.[] | select(.type=="tdengine")'
          
          # æ£€æŸ¥ä»ªè¡¨æ¿
          echo "æ£€æŸ¥å·²å¯¼å…¥çš„ä»ªè¡¨æ¿:"
          curl -s -u "${{ env.GRAFANA_USER }}:${{ env.GRAFANA_PASSWORD }}" \
            "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/api/search?type=dash-db" | jq '.[] | {title: .title, uid: .uid}'
      
      - name: ç”Ÿæˆè®¿é—®ä¿¡æ¯
        run: |
          echo "ğŸ‰ Grafana + TDinsight å®‰è£…å®Œæˆ!"
          echo ""
          echo "ğŸ“Š è®¿é—®ä¿¡æ¯:"
          echo "  Grafana URL: http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}"
          echo "  ç”¨æˆ·å: ${{ env.GRAFANA_USER }}"
          echo "  å¯†ç : ${{ env.GRAFANA_PASSWORD }}"
          echo ""
          echo "ğŸ“ˆ TDinsight ä»ªè¡¨æ¿:"
          IFS=',' read -ra DASHBOARD_ARRAY <<< "${{ env.DASHBOARD_IDS }}"
          IFS=',' read -ra UID_ARRAY <<< "${{ env.DASHBOARD_UIDS }}"
          
          for i in "${!DASHBOARD_ARRAY[@]}"; do
            dashboard_id="${DASHBOARD_ARRAY[i]}"
            dashboard_uid="${UID_ARRAY[i]:-}"
            echo "  - ä»ªè¡¨æ¿ ID: $dashboard_id"
            if [ -n "$dashboard_uid" ]; then
              echo "    è®¿é—®é“¾æ¥: http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/d/$dashboard_uid"
            fi
          done
          echo ""
          echo "ğŸ”— TDengine è¿æ¥ä¿¡æ¯:"
          echo "  ä¸»æœº: ${{ env.TDENGINE_HOST }}"
          echo "  ç«¯å£: ${{ env.TDENGINE_PORT }}"
      
      - name: å®‰è£…åæ¸…ç†
        if: always()
        run: |
          echo "ğŸ§¹ æ‰§è¡Œå®‰è£…åæ¸…ç†..."
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f /tmp/grafana-*.log 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"

  post-installation:
    name: å®‰è£…åé…ç½®å’Œä¼˜åŒ–
    needs: install-monitoring
    runs-on:
      - self-hosted
      - customers
      - u2-191
    
    if: success()
    
    steps:
      - name: é…ç½® Grafana å‘Šè­¦è§„åˆ™
        run: |
          echo "âš™ï¸  é…ç½® Grafana å‘Šè­¦è§„åˆ™..."
          
          # ç¤ºä¾‹ï¼šé…ç½®åŸºæœ¬çš„ TDengine è¿æ¥å‘Šè­¦
          curl -X POST \
            -H "Content-Type: application/json" \
            -u "${{ env.GRAFANA_USER }}:${{ env.GRAFANA_PASSWORD }}" \
            -d '{
              "dashboard": {
                "title": "TDengine Health Alerts",
                "tags": ["tdengine", "monitoring"],
                "timezone": "browser",
                "panels": [],
                "time": {"from": "now-1h", "to": "now"},
                "refresh": "30s"
              }
            }' \
            "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/api/dashboards/db" || true
          
          echo "âœ… å‘Šè­¦è§„åˆ™é…ç½®å®Œæˆ"
      
      - name: ç”Ÿæˆå®‰è£…æŠ¥å‘Š
        run: |
          echo "ğŸ“‹ ç”Ÿæˆå®‰è£…æŠ¥å‘Š..."
          
          cat > /tmp/installation-report.md << EOF
          # Grafana + TDinsight å®‰è£…æŠ¥å‘Š
          
          ## å®‰è£…ä¿¡æ¯
          - **å®‰è£…æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **ç›®æ ‡ä¸»æœº**: ${{ env.TARGET_HOST }}
          - **TDengine ä¸»æœº**: ${{ env.TDENGINE_HOST }}:${{ env.TDENGINE_PORT }}
          - **Grafana ç‰ˆæœ¬**: $(curl -s "http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}/api/frontend/settings" | jq -r '.buildInfo.version' 2>/dev/null || echo "æœªçŸ¥")
          
          ## è®¿é—®ä¿¡æ¯
          - **Grafana URL**: http://${{ env.TARGET_HOST }}:${{ env.GRAFANA_PORT }}
          - **ç”¨æˆ·å**: ${{ env.GRAFANA_USER }}
          - **å¯†ç **: ${{ env.GRAFANA_PASSWORD }}
          
          ## å·²å®‰è£…ç»„ä»¶
          - âœ… Grafana æœåŠ¡
          - âœ… TDengine æ•°æ®æºæ’ä»¶
          - âœ… TDinsight ä»ªè¡¨æ¿ (${{ env.DASHBOARD_IDS }})
          
          ## åç»­æ“ä½œå»ºè®®
          1. ç™»å½• Grafana éªŒè¯ä»ªè¡¨æ¿æ˜¾ç¤ºæ­£å¸¸
          2. é…ç½®æ•°æ®æºè¿æ¥å‚æ•°
          3. æ ¹æ®éœ€è¦è‡ªå®šä¹‰ä»ªè¡¨æ¿
          4. è®¾ç½®å‘Šè­¦è§„åˆ™å’Œé€šçŸ¥æ¸ é“
          EOF
          
          echo "ğŸ“„ å®‰è£…æŠ¥å‘Šå·²ç”Ÿæˆ:"
          cat /tmp/installation-report.md
          
          # å¯ä»¥é€‰æ‹©å°†æŠ¥å‘Šä¸Šä¼ åˆ°æŸä¸ªä½ç½®æˆ–å‘é€é€šçŸ¥
          echo "âœ… å®‰è£…æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

